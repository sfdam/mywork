public with sharing class WsRestPefMutui {
  public final static String PAYLOAD_FORZATURA_K = '{"forzatura": "K","codiceIstituto3N": ${CodiceIstituto3N},"ndg": ${NDG},"codiceFiscale": null,"naturaGiuridica": {"nome": null,"codice": null,"descrizione": null},"intestazione": {"cognome": null,"nome": null,"attivita": null},"numeroCointestatari": 0,"codiceStatoCivile": null,"descrizioneStatoCivile": null,"infoNascita": {"data": 0,"luogo": null,"provincia": null,"localita": null},"residenzaLegale": {"via": {"tipo": null,"nome": null,"numero": null},"localita": null,"cap": 0,"comune": null,"provincia": null},"documento": {"codiceTipo": null,"descrizioneTipo": null,"numero": null,"data": 0,"ente": null},"attivitaEcononica": {"cae": 0,"descrizioneCAE": null,"sae": 0,"descrizioneSAE": null,"rae": 0,"descrizioneRAE": null},"telefono": {"prefisso": null,"numero": null},"infoCCIAA": {"dataIscrizioneLegale": 0,"provinciaSedeLegale": null,"numeroIscrizioneLegale": 0,"provinciaAmministrativa": null},"cittadinanzaResidenza": {"tipoCittadinanza": 0,"codiceCittadinanza": 0,"codiceResidenza": 0,"descrizioneCittadinanza": null},"agenzia": {"codice": 0,"descrizione": null},"statusElemento": {"saealternativo": null,"raealternativo": 0,"indicativoMarketing": 0},"descrizioneSAEAlternativo": null,"descrizioneRAEAlternativo": null,"descrizioneIndicativoSocio": null,"descrizioneTipoGruppo": null,"notastatus": {"codiceLingua": null,"codiceMoneta": null,"indicativoFornitore": null},"descrizoneLingua": null,"codiceABI": 0,"fatturazione": {"indicativo": 0,"periodicita": 0},"matricolaFunzionario": 0,"dataCensimento": 0,"residenzaTitolare": {"indirizzo": {"via": {"tipo": null,"nome": null,"numero": null},"localita": null,"cap": 0,"comune": null,"provincia": null}},"centraleRischi": 0,"partitaIVA": null,"numeroCellulare": null,"email": null,"numeroFax": null,"ateco": null,"descrizioneAteco": null,"tabellaPrivacy": {"elementoPrivacy": [{"codiceDato": 0,"descrizioneDato": null,"consenso": null,"data": 0,"agenzia": null,"privFi": null}]},"numeroCellulareAlternativo": null,"emailAlternativo": null,"numeroTelefonoAlternativo": null,"sitoInternet": null,"codiceProfessione": null,"descrizioneProfessione": null,"dataScadenzaDocumento": 0,"numeroAddetti": null,"flagClientePotenziale": null,"codiceAppellativo": null,"descrizioneAppellativo": null,"titoloNonAccademico": {"codice": null,"descrizioneBreve": null,"descrizione": null},"titoloAccademico": {"codice": null,"descrizioneBreve": null,"descrizione": null},"tipoDipendente": 0,"descrizioneTipoDipendente": null,"matricolaDipendente": 0,"indicativoCapoConvenzione": 0,"codiceConvenzione": 0,"indicativoCapoGruppo": 0,"codiceGruppo": 0,"codiceSegmento": null,"datiAggiuntiObbligatori": null,"allineaIntestazione": null,"codiceTAE": null,"descrizioneTAE": null,"flagValidazione": null,"ndgOperatore": 0,"intestazioneOperatore": null,"dataUltimaVariazione": 0,"flagGenerici": {"flagOperatore": null},"ndgOperatorePws": 0,"moduloAdobe": null,"intestazioneAnagrafica": null,"statusAnagrafico1": null,"statusAnagrafico2": null,"filialeMadre": null,"datiAggiuntiviComplementari": {"CentraleRischi": null,"DataScadenzaDocumento": 0,"partitaIVA": null,"codiceProfessione": null,"FlagPep": null,"numeroAddetti": null,"ateco": null,"telefono": null,"numeroCellulare": null,"email": null,"numeroFax": null,"elementoPrivacy.data": null,"FlagAntiterrorismo": null,"emailPec": null,"NazioneAttPrev": null,"ProvAttPrev": null,"numeroCellulareAlternativo": null,"CodClassCliente": null,"elementoPrivacy.privFi1": null,"elementoPrivacy.privFi2": null,"elementoPrivacy.privFi3": null,"elementoPrivacy.privFi4": null,"elementoPrivacy.privFi5": null,"elementoPrivacy.privFi6": null,"elementoPrivacy.privFi7": null,"CodCompRil": null,"RatingProfRischio": null,"CodTitStudio": null,"DataDecesso": 0,"CodSoggEstero": null,"DataRifFatt": 0,"ImpFatt": null,"CodNazCasaMadre": null,"FlagPIL": null,"codiceTAE": null,"FlagBloccoAnag": null,"DescBloccoAnag": null,"FlagNONpresTitEff": null,"DataStampaQuestionario": 0,"CentraleRischiAssociativa": null,"SegmentoB2": null,"AlboArtigiani": null,"CodFiscalePrecedente": null,"CodiceUIFSecondaCittad": null,"BonificoRipetitivoUSA": null,"TelefonoInternazionale": null,"RatingLegalita": null,"NDGanteMigrazione": null,"CodFiscaleAde": null,"ClienteComuneGruppoAss": null,"ClienteSOS": null,"ClienteMagistratura": null,"SettoreLavorativo": null,"RapportoDiLavoro": null,"Abitazione": null,"NumComponentiNucleo": null,"ProdottoInvestimento1": null,"ProdottoInvestimento2": null,"MotivoAssenzaTitolareEff": null,"TipoDocumIdentita2": null,"NumeroDocumento2": null,"DataDocumento2": 0,"LuogoDocumento2": null,"FilialeDiCompetenza": null,"CognomeConiuge": null,"IndirizzoInternet": null,"IndirizzoInternet2": null,"CollegatoPEP": null,"SoggettoIndagato": null,"NDGFiduciante": null,"DataProvvConfisca": 0,"EsitoAccertamento": null,"PosizionePEP": null,"SocietaFiduciaria": null,"CodiceSegmento": null,"TelefonoDitte": null,"AttivitaPrevalente": null,"CensimentoRuoli": null,"ResidenzaFiscaleEstera": null,"CaiIndirizzo": null,"CaiCap": null,"CaiLocalita": null,"CaiProvincia": null,"CaiPaese": null,"ProtezioneAccessiDipendente": null,"LEI": null,"SettoreFCEMIR": null,"SpecieGiuridicaEstera": null,"Eredita": null,"ProceduraConcorsuale": null,"SocCostLeggiStraniere": null,"SAECodificaNuova": null,"SAEEsteroNuovo": null,"SocietaQuotBorsa": null,"DataFondazione": 0,"NazioneCostruzione": null,"CodiceIban": null,"ProALBODitteIndiv": null,"IscrittiALBODitteIndivid": null,"GestioneBolli": null,"PrefissoTelCasa": null,"PrefissoTelAlterativo": null,"PrefissoCell1": null,"PrefissoCell2": null,"NDGSettorialeEstero": null,"CodFiscaleEstero": null,"CodiceCorrEstero": null,"CodiceSWIFT": null,"TipoClienteFATCA": null,"DatiDocFATCA": null,"FATCADichiarazResidenzaUS": null,"PosizioneFATCA": null,"PrimaResidenzaFATCA": null,"SecondaResidenzaFATCA": null,"TerzaResidenzaFATCA": null,"QuartaResidenzaFATCA": null,"QuintaResidenzaFATCA": null,"FACTAEntity": null,"FACTAGIIN": null,"TerzaCittadinanzaFATCA": null,"Note2CodFiscFATCA": null,"Note3CodFiscFATCA": null,"Note4CodFiscFATCA": null,"TrasparenzaFiscale": null,"PosizioneCRS": null,"EntityCRS": null,"DatiDocumento02CRS": null,"Note5CodFiscFATCA": null,"DocAggiuntivoFATCA": null,"NumRapportiDirettiInEssere": null,"NumRapportiDirettiEstinti": null,"NumRapportiIndirettiEstinti": null,"DataIscrizione": 0,"MiniIntestazione1": null,"MiniIntestazione2": null,"CabResidenza": null,"CabNascita": null,"PosEstero": null,"DataAccensioneProvv": 0,"DataAccensioneDefin": 0,"DataAccensionePrimoRapp": 0,"DataEstinzioneUltCc": 0,"DataEstinzioneUltRapp": 0,"DataUltimaVariazioneAnagrafica": 0,"DataCaricamentoInProvv": 0,"DataCaricamentoInDefin": 0,"TipoReteInformativa": null,"DepositoAlPortatore": null,"PeriodoSorveglianza": null,"IndicativoSorveglianza": null}}';

  /**
   * Interrogazione bilanci (PEF17)
   **/
  public static PeriodiBilanciCensitiResponse periodiBilanciCensiti(PeriodiBilanciCensitiInput input) {
    return (PeriodiBilanciCensitiResponse) WsRestUtils.callService(
      'UrlInterrogazioneBilanci__c',
      input,
      PeriodiBilanciCensitiResponse.class
    );
  }

  /**
   *  Servizio di richiesta prima info CR CEDACRI 170
   */
  public static RichiestaCrResponse infoCr(InfoCrInput input) {
    // MB - TEN: MODIFICATA CHIAMATA PER RIMOZIONE ECCEZIONE IN CASO DI RISPOSTA NON OK
    // return (RichiestaCrResponse) WsRestUtils.callService(
    //   'UrlInfoCr__c',
    //   input,
    //   RichiestaCrResponse.class
    // );
    return (RichiestaCrResponse) WsRestUtils.callServiceWithouthCatch(
      'UrlInfoCr__c',
      input,
      RichiestaCrResponse.class
    );
  }

  /**
   * Sets the folder status (PEF20)
   **/
  public static StatoCartellaResponse statoCartella(StatoCartellaInput input) {
    return (StatoCartellaResponse) WsRestUtils.callService(
      'UrlAggiornamentoStatoCartella__c',
      input,
      StatoCartellaResponse.class
    );
  }

  /**
   * Gets info about a PEF (PEF23)
   **/
  public static CheckStatoPefResponse checkStatoPef(CheckStatoPefInput input) {
    input.lingua = null;
    input.idSessioneChiamante = null;
    input.idApplicazioneChiamante = null;
    return callPefService(input, 'UrlCheckStatoPef__c');
  }

  /**
     * Controlla se esiste una pratica attiva per un dato ndg. Non passare codPratica
     **/
  public static CheckStatoPefResponse esistePef(CheckStatoPefInput input) {
    input.lingua = null;
    input.idSessioneChiamante = null;
    input.idApplicazioneChiamante = null;
    return callPefService(input, 'UrlEsistePef__c');
  }

  public static CheckStatoPefResponse callPefService(CheckStatoPefInput input, String url) {
    return (CheckStatoPefResponse) WsRestUtils.callService(url, input, CheckStatoPefResponse.class);
  }

  @future(callout = true)
  public static void syncAllineaKnet(String ndg) {
    AllineaKnetResponse alKnet = new AllineaKnetResponse();

    alKnet = allineaKnet(ndg);

  }
  public static AllineaKnetResponse allineaKnet(String ndg) {
    String codiceIstituto3N = String.valueOf(ImpostazioniServizi__c.getInstance().CodiceIstituto3N__c);
    System.debug('SV allineaKnet codiceIstituto3N: ' + codiceIstituto3N);
    System.debug('SV allineaKnet ndg: ' + ndg);
    return (AllineaKnetResponse) WsRestUtils.callServiceWithouthCatch(
      'UrlAllineaKnet__c',
      JSON.deserializeUntyped(PAYLOAD_FORZATURA_K.replace('${NDG}', ndg).replace('${CodiceIstituto3N}', codiceIstituto3N)),
      AllineaKnetResponse.class
    );
  }

  // input payloads
  public class InfoCrInput extends WsRestInput.CommonInput {
    public Long ndg;
  }

  /**
   * Class containing input data to invoke "PeriodiBilanciCensiti" service
   */
  public class PeriodiBilanciCensitiInput extends WsRestInput.CommonInput {
    public Long ndg;
    public String codiceFiscale;
    public String flagProvvisorio;
  }

  /**
   * Class containing input data to invoke "StatoCartella" service
   */
  public class StatoCartellaInput extends WsRestInput.CommonInput {
    public String provenienza;
    public String idCartella;
    public String keyCollegamentoPratica;
    public Integer codiceStato;
    public ProdottiNonDeliberati prodottiNonDeliberati;
  }

  /**
   * Class containing input data to invoke "CheckStatoPef" service
   */
  public class CheckStatoPefInput extends WsRestInput.CommonInput {
    public Long codNdg;
    public Decimal codPratica;
  }

  // output payloads

  /**
   * Class containing output data received from invoking "PeriodiBilanciCensiti" service
   */
  public class PeriodiBilanciCensitiOutput extends WsRestInput.CommonInput {
    public String ateco;
    public String schema;
    public String flagConsolidato;
    public Integer durataInMesi;
    public Bilancio bilancio;
    public VoceGrezza[] vociGrezze;
  }

  /**
   * Class containing output data received from invoking "StatoCartella" service
   */
  public class StatoCartellaOutput { // serve?
  }

  /**
   * Class containing output data received from invoking "CheckStatoPef" service
   */
  public class CheckStatoPefOutput {
    public String resultCode;
    public OutputRichiesta outputRichiesta;
    public String resultMessage;
    public ErrorDetail[] errorDetails;
  }

  public class RichiestaCrOutput {
    public String codice;
    public String descrizione;
    public Decimal protocollo;
  }

  // stubs

  public class Bilancio {
    public Long codiceDocumento;
    public Long inizioPeriodo;  // Unix Timestamp in Milliseconds ?
    public Long finePeriodo;    // Unix Timestamp in Milliseconds ?
    public String stato;
  }

  public class ErrorDetail {
    public String code;
    public String type;
    public String descr;
    public String soluzione;
  }

  public class OutputRichiesta {
    public Integer codiceIstituto3N;
    public Long codNDG;
    public Decimal codPratica;
    public String codTipoPratica;
    public String codStatoPratica;
    public String desStatoPratica;
    public String flagPraticaAttiva;
    public String flagEsistePefAttiva;
    public String codUtenteAttivo;
    public String codUtenteDeliberante;
    public String codRuoloDeliberante;
  }

  public class ProdottiNonDeliberati {
    public Prodotto[] prodotto;
  }

  public class Prodotto {
    public Integer idProdotto;
    public String keyCollegamentoProdotto;
    public String dataIstruttoria;
    public long idIstruttoria;
    public String dataIstruttoriaFiglio;
    public long idIstruttoriaFiglio;
    public String nota;
  }

  public class VoceGrezza {
    public String voce;
    public String valoreAnno1;
    public String valoreAnno2;
    public String valoreAnno3;
    public String valoreAnno4;
    public String valoreAnno5;
  }

  public class AllineaKnetOutput {
    public String ledger;
    public String result;
    public String message;
  }

  // responses
  public class AllineaKnetResponse extends WsRestInput.CommonResponse {
    public AllineaKnetOutput[] payload;

    public override Boolean isCorrect() {
      Boolean res = payload != null && !payload.isEmpty();
      if (!res) return false;

      for (AllineaKnetOutput r : payload) {
        if (r.ledger == 'KNT' && r.result == 'UPDATED') return true;
      }

      return false;
    }

    public override String getErrors() {
      Boolean res = payload != null && !payload.isEmpty();
      if (!res) return 'Errore nel payload';

      for (AllineaKnetOutput r : payload) {
        if (r.ledger == 'KNT') return r.message;
      }

      return 'Errore nel payload';
    }
  }

  public class PeriodiBilanciCensitiResponse extends WsRestInput.CommonResponse {
    public PeriodiBilanciCensitiOutput payload;

    public override Boolean isCorrect() {
      return payload != null;
    }
  }

  public class StatoCartellaResponse extends WsRestInput.CommonResponse {
    public StatoCartellaOutput payload;

    public override Boolean isCorrect() {
      return payload != null;
    }
  }

  public class RichiestaCrResponse extends WsRestInput.CommonResponse {
    public RichiestaCrOutput payload;

    public override Boolean isCorrect() {
      return payload != null && (
        payload.codice == 'OK' ||
        payload.descrizione == 'ATTENZIONE : Funzione non permessa - Richiesta già esistente.'
      );
    }

    public override String getErrors() {
      if (payload == null) return super.getErrors();
      else if (payload.codice == 'KO') return payload.descrizione;
      else return '';
    }
  }

  public class CheckStatoPefResponse extends WsRestInput.CommonResponse {
    public CheckStatoPefOutput payload;

    public override Boolean isCorrect() {
      return (payload != null && payload.resultCode == '0');
    }
  }
}