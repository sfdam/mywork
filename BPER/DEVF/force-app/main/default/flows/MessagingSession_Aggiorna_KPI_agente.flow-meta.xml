<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>54.0</apiVersion>
    <assignments>
        <name>Add_to_metrics_collection</name>
        <label>Add to metrics collection</label>
        <locationX>727</locationX>
        <locationY>1230</locationY>
        <assignmentItems>
            <assignToReference>MessagignSessionMetrics</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>MessagingSessionMetric</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_over_entries</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_LastEndUserEntry</name>
        <label>Set LastEndUserEntry</label>
        <locationX>233</locationX>
        <locationY>1504</locationY>
        <assignmentItems>
            <assignToReference>LastEndUserConversationEntry</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_entries</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>IsLastEndUserMessageSet</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_over_entries</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_metric</name>
        <label>Set metric</label>
        <locationX>725</locationX>
        <locationY>1363</locationY>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_ActorType__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_entries.ActorType</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_EntryID__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_entries.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_EntryTime__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_entries.EntryTime</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_MessaginSession__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_entries.ConversationId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_ParentEntryDate__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>LastEndUserConversationEntry.EntryTime</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_ParentEntryID__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>LastEndUserConversationEntry.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_Sequence__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_entries.Seq</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_Actor__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_entries.ActorId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_Message__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_entries.Message</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>MessagingSessionMetric.CRM_ParentMessage__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>LastEndUserConversationEntry.Message</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>IsLastEndUserMessageSet</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_to_metrics_collection</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Check_actorType</name>
        <label>Check actorType</label>
        <locationX>535</locationX>
        <locationY>1371</locationY>
        <defaultConnector>
            <targetReference>Loop_over_entries</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Esito predefinito</defaultConnectorLabel>
        <rules>
            <name>Is_agent</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_over_entries.ActorType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Agent</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_metric</targetReference>
            </connector>
            <label>Is agent</label>
        </rules>
        <rules>
            <name>Is_EndUser</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_over_entries.ActorType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>EndUser</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Check_lastEndUserMessage</targetReference>
            </connector>
            <label>Is EndUser</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_CE</name>
        <label>Check CE</label>
        <locationX>539</locationX>
        <locationY>486</locationY>
        <defaultConnector>
            <targetReference>Update_MessagingSession_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>CE is nulla</defaultConnectorLabel>
        <rules>
            <name>CE_is_set</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_ConversationEntry</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_MessagingSession</targetReference>
            </connector>
            <label>CE is set</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_lastEndUserMessage</name>
        <label>Check lastEndUserMessage</label>
        <locationX>412</locationX>
        <locationY>1498</locationY>
        <defaultConnector>
            <targetReference>Set_LastEndUserEntry</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>last message is null</defaultConnectorLabel>
        <rules>
            <name>last_message_is_set</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>IsLastEndUserMessageSet</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Loop_over_entries</targetReference>
            </connector>
            <label>last message is set</label>
        </rules>
    </decisions>
    <interviewLabel>MessagingSession - Aggiorna KPI agente {!$Flow.CurrentDateTime}</interviewLabel>
    <label>MessagingSession - Aggiorna KPI agente</label>
    <loops>
        <name>Loop_over_entries</name>
        <label>Loop over entries</label>
        <locationX>527</locationX>
        <locationY>1113</locationY>
        <collectionReference>Get_conversation_entries</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Check_actorType</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Create_metricsCollection</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>Create_metricsCollection</name>
        <label>Create metricsCollection</label>
        <locationX>1053</locationX>
        <locationY>1169</locationY>
        <inputReference>MessagignSessionMetrics</inputReference>
    </recordCreates>
    <recordLookups>
        <name>Get_conversation_entries</name>
        <label>Get conversation entries</label>
        <locationX>521</locationX>
        <locationY>914</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_over_entries</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>ConversationId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.WorkItemId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>ConversationEntry</object>
        <sortField>Seq</sortField>
        <sortOrder>Asc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_ConversationEntry</name>
        <label>Get ConversationEntry</label>
        <locationX>729</locationX>
        <locationY>466</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Check_CE</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>ConversationId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.WorkItemId</elementReference>
            </value>
        </filters>
        <filters>
            <field>ActorType</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Agent</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ConversationEntry</object>
        <sortField>Seq</sortField>
        <sortOrder>Asc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_LastConversationEntry</name>
        <label>Get LastConversationEntry</label>
        <locationX>921</locationX>
        <locationY>380</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_ConversationEntry</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>ConversationId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.WorkItemId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ConversationEntry</object>
        <sortField>Seq</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_MessagingSession</name>
        <label>Update MessagingSession</label>
        <locationX>621</locationX>
        <locationY>689</locationY>
        <connector>
            <targetReference>Get_conversation_entries</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.WorkItemId</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>CRM_DataOraUltimoMessaggio__c</field>
            <value>
                <elementReference>Get_LastConversationEntry.EntryTime</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>CRM_DateTimeAgentFirstAnswer__c</field>
            <value>
                <elementReference>Get_ConversationEntry.EntryTime</elementReference>
            </value>
        </inputAssignments>
        <object>MessagingSession</object>
    </recordUpdates>
    <recordUpdates>
        <name>Update_MessagingSession_0</name>
        <label>Update MessagingSession</label>
        <locationX>416</locationX>
        <locationY>695</locationY>
        <connector>
            <targetReference>Get_conversation_entries</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.WorkItemId</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>CRM_DataOraUltimoMessaggio__c</field>
            <value>
                <elementReference>Get_LastConversationEntry.EntryTime</elementReference>
            </value>
        </inputAssignments>
        <object>MessagingSession</object>
    </recordUpdates>
    <start>
        <locationX>716</locationX>
        <locationY>50</locationY>
        <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Closed</stringValue>
            </value>
        </filters>
        <filters>
            <field>ServiceChannelRelatedEntity__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>MessagingSession</stringValue>
            </value>
        </filters>
        <object>AgentWork</object>
        <recordTriggerType>Update</recordTriggerType>
        <scheduledPaths>
            <pathType>AsyncAfterCommit</pathType>
        </scheduledPaths>
        <scheduledPaths>
            <name>Dopo_1_minuto</name>
            <connector>
                <targetReference>Get_LastConversationEntry</targetReference>
            </connector>
            <label>Dopo 1 minuto</label>
            <offsetNumber>1</offsetNumber>
            <offsetUnit>Minutes</offsetUnit>
            <recordField>CloseDateTime</recordField>
            <timeSource>RecordField</timeSource>
        </scheduledPaths>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>IsLastEndUserMessageSet</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <booleanValue>false</booleanValue>
        </value>
    </variables>
    <variables>
        <name>LastEndUserConversationEntry</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ConversationEntry</objectType>
    </variables>
    <variables>
        <name>MessagignSessionMetrics</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>CRM_MessagingSessionMetrics__c</objectType>
    </variables>
    <variables>
        <name>MessagingSessionMetric</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>CRM_MessagingSessionMetrics__c</objectType>
    </variables>
</Flow>
