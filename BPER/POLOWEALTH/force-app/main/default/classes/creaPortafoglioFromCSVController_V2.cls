public without sharing class creaPortafoglioFromCSVController_V2 
{
	/**
	* @description: riceve il file dal componente lightning e lo manda in elaborazione 
	* @param mtdCsvFile: file 
	* @param mtdCsvName: nome file 
	*/ 
	@AuraEnabled
	public static statusWrapper upldFile(object mtdCsvFile, object mtdCsvName, list<string> mtdFileRows, boolean erroreRighe, string SV_CSVLoad){
	
		statusWrapper mtdStatus = new statusWrapper();
		SV_CSVLoad__c mtdFileRecordLog = [select id from SV_CSVLoad__c where id = :SV_CSVLoad];
        system.debug(mtdFileRows);
        //list<string> mappa= (list<string>)System.JSON.deserialize(mtdFileRows, list<string>.class);
        //system.debug(mappa);
        setLogRecord(String.valueOf(mtdCsvFile), String.valueOf(mtdCsvName), SV_CSVLoad);
		try{
			if(erroreRighe)
            {
                mtdStatus.setStatusWrapper(system.label.Elaborazione_csv_error_title, 
											'error', 
											system.label.Elaborazione_csv_error_body);
                ListException e = new ListException();
                e.setMessage('Lunghezza righe errata');
                //setLog(mtdFileRecordLog, e, erroreRighe);
            }
            else
            {
				mtdFileRecordLog.Status__c = 'Loading';
				update mtdFileRecordLog;
				
                creaPortafoglioFromCSVBatch efm = new creaPortafoglioFromCSVBatch(mtdFileRows, mtdFileRecordLog, String.valueOf(mtdCsvName));
                Database.executeBatch(efm, 1);
			
                mtdStatus.setStatusWrapper(label.Elaborazione_csv_success_title, 
											'success', 
											label.Elaborazione_csv_success_toast);
            }
			
			return mtdStatus;
			
		}catch(Exception e){
            //setLog(mtdFileRecordLog, e, false);
			mtdStatus.setstatusWrapper('Errore', 'error', 'Cause: '+e.getCause()+'; LineNumber: '+e.getLineNumber()+'; TypeName: '+e.getTypeName()+'; StackTrace: '+e.getStackTraceString()+'; Message: '+e.getMessage());
			return mtdStatus;
		}	
	}
    
    //-------------------------------metodi utilizzati------------------------------------
	/**
	* @description: crea un record di log per il bacth di elaborazione a cui allega il file caricato 
	* @param mtdFileRecordLog: record da scrivere
	* @param mtdCsvFile: file da allegare 
	* @param mtdCsvName: nome del file 
	*/ 
	private static void setLogRecord(string mtdCsvFile, string mtdCsvName, string SV_CSVLoad){
		//imposta il nome del file e la data di inizio elaborazione nel record di log
		/*mtdFileRecordLog.nome_file__c = mtdCsvName;
		mtdFileRecordLog.data_inizio_elaborazione__c = System.now();
        mtdFileRecordLog.test__c = '';
        mtdFileRecordLog.Errore_Righe__c = false;
        mtdFileRecordLog.Riga_Errore__c = '';
        mtdFileRecordLog.template__c = template;*/

		//inserisce il reocord log
		//insert mtdFileRecordLog;

		if(!Test.isrunningTest()) 
		{
			//allega il file elaborato
			ContentVersion cv = new ContentVersion();
			cv.ContentLocation = 'S';
			cv.VersionData = Blob.valueOf(mtdCsvFile);
			cv.Title = System.now()+' - ' + mtdCsvName;
			cv.PathOnClient = System.now()+' - ' + mtdCsvName;
			
			//ArtUtility.printDebug(cv, 'cv', imf.ACTIVATE_DEBUG__c);
			
			insert cv;
			
			//ArtUtility.printDebug(cv.contentDocumentId, 'contentDocumentId', imf.ACTIVATE_DEBUG__c);        
			
			ContentDocumentLink cdl = new ContentDocumentLink();
			cdl.ContentDocumentId = [SELECT Id, ContentDocumentId FROM ContentVersion WHERE Id =: cv.Id].ContentDocumentId;
			cdl.LinkedEntityId = SV_CSVLoad;
			cdl.ShareType = 'I';
			
			//ArtUtility.printDebug(cdl, 'cdl', imf.ACTIVATE_DEBUG__c);
			
			insert cdl;
		}
	}

	public static void setLog(SV_CSVLoad__c mtdFileRecordLog, Exception e, boolean Righeerrore){
	
		/*string errorMsg = 'Cause: '+e.getCause()
						+'; LineNumber: '+e.getLineNumber()
						+'; TypeName: '+e.getTypeName()
						+'; StackTrace: '+e.getStackTraceString()
						+'; Message: '+e.getMessage();
		mtdFileRecordLog.Batch_Messages__c = (mtdFileRecordLog.Batch_Messages__c != null)? mtdFileRecordLog.Batch_Messages__c + ' \n ' + errorMsg : errorMsg;
		if(mtdFileRecordLog.Batch_Messages__c.length() > 131072) mtdFileRecordLog.Batch_Messages__c.substring(0, 131072);
		mtdFileRecordLog.Messaggio_Errore__c = e.getMessage();
		mtdFileRecordLog.error__c = true;
		mtdFileRecordLog.stato__c = 'Non completato';
		mtdFileRecordLog.data_fine_elaborazione__c = System.now();
		mtdFileRecordLog.Errore_Righe__c = Righeerrore;
		*/
		mtdFileRecordLog.Status__c = 'Loading';
		update mtdFileRecordLog;
	}

	//Wrapper Classes
	/**
	* @description: response da inviare al componente 
	*/ 
	public class statusWrapper{
		@AuraEnabled
		public string title;//intestazione notifica
		@AuraEnabled
		public string status;//success \ error
		@AuraEnabled
		public string errorMsg;//messaggio di errore

		public statusWrapper(){
			this.title = '';
			this.status = '';
			this.errorMsg = '';
		}

		public void setStatusWrapper(string tl, string st, string err){
			this.title = tl;
			this.status = st;
			this.errorMsg = err;
		}
	}
	public static void testRun() {
        Integer i = 0;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
    }
}